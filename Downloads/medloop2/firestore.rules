rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---
    
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Role Checks
    function isAdmin() {
      return isAuthenticated() && getUserData().role == 'admin';
    }
    function isSecretary() {
      return isAuthenticated() && getUserData().role == 'secretary';
    }
    function isDoctor() {
      return isAuthenticated() && getUserData().role == 'doctor';
    }

    // Data Validation Helpers
    function isValidPatient() {
       let data = request.resource.data;
       return data.name is string && data.name.size() > 2 && data.name.size() < 100
           && data.age is number && data.age > 0 && data.age < 120
           && data.phone is string
           && data.clinicId is string;
    }

    // --- COLLECTION RULES ---

    match /users/{userId} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      // Only Admin can create users to ensure role integrity
      allow write: if isAdmin();
    }

    match /clinics/{clinicId} {
      allow read: if isAuthenticated();
      // Admin only management
      allow write: if isAdmin();
    }

    match /patients/{patientId} {
      // READ: 
      // Admin/Secretary: All
      // Doctor: Only if clinicId matches one of their assigned clinics
      allow read: if isAdmin() 
                  || isSecretary() 
                  || (isDoctor() && resource.data.clinicId in getUserData().clinicIds);

      // CREATE:
      // Secretary only (Doctors typically don't do intake in this flow, but can be added if needed)
      // Must validate data structure
      allow create: if (isAdmin() || isSecretary()) && isValidPatient();
      
      // UPDATE:
      // Doctor can only update status/notes, NOT the clinicId or createdBy fields (Immutability)
      allow update: if (isAdmin() || isSecretary() || 
                       (isDoctor() && resource.data.clinicId in getUserData().clinicIds))
                    && request.resource.data.clinicId == resource.data.clinicId // Prevent moving patient
                    && request.resource.data.createdAt == resource.data.createdAt; // Audit trail integrity
                    
      allow delete: if isAdmin();
    }
  }
}